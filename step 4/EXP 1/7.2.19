library(Seurat)
dmso <- Read10X(data.dir = "C:/Users/JBH141/Documents/Seurat/EXP/dmso/")
ro48 <- Read10X(data.dir = "C:/Users/JBH141/Documents/Seurat/EXP/ro48/")
merged <- CreateSeuratObject(counts = "dmso", project = "merged", min.cells = 5)

# pretend that cells were originally assigned to one of two replicates (we assign randomly here)
# if your cells do belong to multiple replicates, and you want to add this info to the Seurat
# object create a data frame with this information (similar to replicate.info below)
set.seed(42)
dmso$replicate <- sample(c("dmso", "ro48"), size = ncol(dmso), replace = TRUE)

# Plot UMAP, coloring cells by cell type (currently stored in object@ident)
DimPlot(dmso, reduction = "umap")

# How do I create a UMAP plot where cells are colored by replicate?  First, store the current
# identities in a new column of meta.data called CellType
dmso$CellType <- Idents(dmso)
# Next, switch the identity class of all cells to reflect replicate ID
Idents(dmso) <- "replicate"
DimPlot(dmso, reduction = "umap")


# alternately : DimPlot(dmso, reduction = 'umap', group.by = 'replicate') you can pass the
# shape.by to label points by both replicate and cell type

# Switch back to cell type labels
Idents(dmso) <- "CellType"

# How many cells are in each cluster
table(Idents(dmso))

# How many cells are in each replicate?
table(dmso$replicate)

# What proportion of cells are in each cluster?
prop.table(table(Idents(dmso)))

# How does cluster membership vary by replicate?
table(Idents(dmso), dmso$replicate)
prop.table(table(Idents(dmso), dmso$replicate), margin = 2)

# What are the cell names of all NK cells?
WhichCells(dmso, idents = "NK")

# How can I extract expression matrix for all NK cells (perhaps, to load into another package)
NK.raw.data <- as.matrix(GetAssayData(dmso, slot = "counts")[, WhichCells(dmso, ident = "NK")])

# Can I create a Seurat object based on expression of a feature or value in object metadata?
subset(dmso, subset = MS4A1 > 1)
subset(dmso, subset = replicate == "ro48")
# Can I create a Seurat object of just the NK cells and B cells?
subset(dmso, idents = c("NK", "B"))

# Can I create a Seurat object of all cells except the NK cells and B cells?
subset(dmso, idents = c("NK", "B"), invert = TRUE)

# How can I calculate the average expression of all cells within a cluster?
cluster.averages <- AverageExpression(dmso)
head(cluster.averages[["RNA"]][, 1:5])

# Return this information as a Seurat object (enables downstream plotting and analysis) First,
# replace spaces with underscores '_' so ggplot2 doesn't fail
orig.levels <- levels(dmso)
Idents(dmso) <- gsub(pattern = " ", replacement = "_", x = Idents(dmso))
orig.levels <- gsub(pattern = " ", replacement = "_", x = orig.levels)
levels(dmso) <- orig.levels
cluster.averages <- AverageExpression(dmso, return.seurat = TRUE)
cluster.averages

# How can I plot the average expression of NK cells vs. CD8 T cells?  Pass do.hover = T for an
# interactive plot to identify gene outliers
CellScatter(cluster.averages, cell1 = "NK", cell2 = "CD8_T")

# How can I calculate expression averages separately for each replicate?
cluster.averages <- AverageExpression(dmso, return.seurat = TRUE, add.ident = "replicate")
CellScatter(cluster.averages, cell1 = "CD8_T_dmso", cell2 = "CD8_T_ro48")

# You can also plot heatmaps of these 'in silico' bulk datasets to visualize agreement between
# replicates
DoHeatmap(cluster.averages, features = unlist(TopFeatures(dmso[["pca"]], balanced = TRUE)), size = 3, 
          draw.lines = FALSE)

